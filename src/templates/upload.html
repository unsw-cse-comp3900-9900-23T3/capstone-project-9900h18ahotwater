<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <link href="assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #212529;
            display: block;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .header {
            padding-right: 40px;
            padding-left: 40px;
        }

        .header_default {
            min-height: 96px;
            flex-wrap: nowrap;
            justify-content: space-between;
            align-items: center;
            display: flex;
            font-family: Arial, sans-serif;
        }

        .header-left {
            order: 0;
            align-self: auto;
            align-items: center;
            display: flex;

        }

        .header-right {
            text-align: center;
            align-self: center;
            align-items: center;
            display: flex;

        }

        .header-right a {
            margin-left: 12px;
            margin-right: 12px;
            padding: 12px;
            display: inline-block;
            text-decoration: none;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: #4D049A;
        }

        .header-log {
            color: #111827;
            font: 16px Inter sans-serif;
            background: #FFFFFF;
            padding: 13px 20px;
        }

        .fa_icon {
            font-family: Font Awesome Regular, sans-serif;
        }

        .fa_icon.button-pad-l {
            padding-left: 6px;
            padding-right: 4px;
        }

        .left_item {
            margin-left: 12px;
            margin-right: 12px;
            padding: 12px;
            display: inline-block;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: #FFFFFF;
        }

        .nav-link {
            margin-left: 12px;
            margin-right: 12px;
            padding: 12px;
            display: inline-block;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: #FFFFFF;
        }

        .dropdown-item {
            display: inline-block;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: #FFFFFF;
        }

        .dropdown-menu {
            background: #212529;
        }

        .header-left a:hover {
            border-bottom: 2px solid deepskyblue;
        }

        .header-right a {
            margin-left: 12px;
            margin-right: 12px;
            padding: 12px;
            display: inline-block;
            text-decoration: none;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: #4D049A;
        }

        .header-log {
            color: #111827;
            font: 16px Inter sans-serif;
            background: #FFFFFF;
            padding: 13px 20px;
        }

        nav ul {
            list-style: none;
            padding: 0;
            display: flex;
            justify-content: flex-start;
        }

        nav li {
            margin-right: 20px;
        }

        nav a {
            text-decoration: none;
            color: #fff;
        }

        nav a:hover {
            text-decoration: underline;
        }

        .carousel img {
            width: 100%;
            display: inline-block;
        }

        .box {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 50px auto;
            padding-top: 30px;
            background-image: url('images/drag_file.png'); /* 你要设置的背景图片 */
            background-size: cover;
            background-position: center;
            background-color: #f5f5f5 !important;
            border-radius: 10px;
        }

        .btn {
            width: 200px;
            height: 30px;
            line-height: 30px;
            margin: 280px auto;
            text-align: center;
            color: #5098F8;
            border-radius: 4px;
            border: 1px dashed #5098F8;
            cursor: pointer;
        }

        .container1 {
            background: #212529;
            color: #6B7280;
            text-align: center;
        }

        .container1 h3 {
            color: #dee2e6;
        }

        label[for="upload-input"] {
            display: block;
            background-color: #5098F8;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
        }

        .nav-link:focus, .nav-link:hover {
            color: #FFFFFF;
        }

        #file-btn {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .image-wrapper img {
            width: 200px;
            height: 150px;
        }


        .description-input {
            height: 200px;
            width: 400px;
            padding: 10px;
            display: block;
        }


        .description-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .show {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }


        #image-submit {
            display: block;
            width: 150px;
            height: 50px;
            margin: 0 auto;
            background-color: #4D049A;
            color: #fff;
            font-size: 18px;
            border: none;
            cursor: pointer;
            border-radius: 10px;
        }

        .space {
            height: 20px;
        }

        .show_space {
            height: 20px;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        #loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

    </style>
</head>


<body>

<div class="header">
    <div class="header_default">
        <a href="/"
        ><img
                src="images/logo1.png"
                loading="lazy"
                width="200"
                height="74"
                alt="logo"
        /></a>
        <div class="header-left">
            <a class="left_item" href="/">Home</a>
            <a class="left_item" href="/introduction">Introduction</a>
            <a class="left_item" href="/performance">Performance</a>
            <a class="left_item" href="/upload">Upload</a>
        </div>
        <div class="header-right">
            {% if session.email %}
                <span style="color: #FFFFFF">Welcome, {{ session.email }}</span>
                <a class="header-log" href="#" id="logout-link">Logout<span class="fa_icon button-pad-l">→</span></a>
            {% else %}
                <a class="header-log" href="/login">Login<span class="fa_icon button-pad-l">→</span></a>
            {% endif %}

        </div>
    </div>
</div>
<div class="box" id="drop">
    <input type="file" id="file-btn" onchange="selectFile(event)" accept=".jpeg,.png,.jpg" multiple>
</div>
<div class="show">
    <div id="image-container">

    </div>

    <div class="show_space"></div>
    <div id="description-container">

    </div>
</div>
<div id="loading-overlay">
    <div id="loading-spinner"></div>
    <p>Loading...</p>
</div>
<!-- 模态对话框 -->
<div id="myModal" class="modal">
    <div id="result-container">
        <span class="close" id="modal-close">&times;</span>
        <div id="modal-image-container">
            <!-- 这里显示上传的图片 -->
        </div>
        <div id="modal-data-container">
            <!-- 这里显示返回的数据 -->
        </div>
    </div>
</div>

<footer class="pt-3 mt-4 text-body-secondary border-top container1 py-5">
    <div class="row">

        <div class="col-12 col-md">
            <img src="images/logo1.png" alt="Company Logo">
            <br>
            <br>
            <small class="d-block mb-3" style="text-align:center">© 2023 Hotwater, Inc.</small>
            <small class="d-block mb-3" style="text-align:center">All rights reserved.</small>
        </div>
        <div class="col-12 col-md">
            <h3>Links</h3>
            <ul class="list-unstyled text-small">
                <li><a class="link-secondary text-decoration-none" href="/">Home</a></li>
                <li><a class="link-secondary text-decoration-none" href="/introduction">Introduction</a></li>
                <li><a class="link-secondary text-decoration-none" href="/performance">Performance</a></li>
                <li><a class="link-secondary text-decoration-none" href="/login">Login</a></li>
            </ul>
        </div>
        <div class="col-12 col-md">
            <h3>Introduction</h3>
            <ul class="list-unstyled text-small">
                <li><a class="link-secondary text-decoration-none" href="/data-preprocessing">Data pre-processing</a>
                </li>
                <li><a class="link-secondary text-decoration-none" href="/model_1">Model - Ⅰ</a></li>

            </ul>
        </div>
        <div class="col-12 col-md">
            <h3>About</h3>
            <ul class="list-unstyled text-small">
                <li><a class="link-secondary text-decoration-none" href="#">Team</a></li>
                <li><a class="link-secondary text-decoration-none" href="#">Locations</a></li>
                <li><a class="link-secondary text-decoration-none" href="#">Privacy</a></li>
                <li><a class="link-secondary text-decoration-none" href="#">Terms</a></li>
            </ul>
        </div>
    </div>
</footer>
<script src="assets/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let selectedImages = [];

    function selectFile(e) {

        if (e.target.files.length > 0) {
            const selectedFiles = e.target.files;
            const validFiles = [];
            const displayedImagesCount = document.querySelectorAll('.image-wrapper').length;

            for (let i = 0; i < selectedFiles.length; i++) {
                if (isValidFileType(selectedFiles[i])) {
                    validFiles.push(selectedFiles[i]);
                    selectedImages.push(selectedFiles[i].name);
                }
            }
            if (validFiles.length > 0) {
                const remainingSlots = 2 - displayedImagesCount;
                if (validFiles.length <= remainingSlots) {

                    for (let i = 0; i < validFiles.length; i++) {
                        displayImage(validFiles[i]);
                    }
                    alert('Success! ' + validFiles.length + ' files selected.');

                } else {
                    alert('You can only upload a maximum of two files. You have ' + displayedImagesCount + ' images already.');
                    e.target.value = '';

                }

            } else {
                alert('Please select the correct file types (Image documents or Video documents)');
                e.target.value = '';
            }

        }
    }

    function displayImage(file) {

        if (file.type.startsWith("image/")) {
            const imageContainer = document.querySelector('#image-container');
            const descriptionContainer = document.querySelector('#description-container');

            const imageWrapper = document.createElement("div");
            imageWrapper.classList.add("image-wrapper");
            imageWrapper.style.display = "inline-block";

            const image = document.createElement("img");
            image.classList.add("dragged-image");
            image.src = URL.createObjectURL(file);

            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.addEventListener('click', function () {
                imageContainer.removeChild(imageWrapper);

                if (imageContainer.querySelectorAll(".image-wrapper").length === 0) {

                    const descriptionInput = document.querySelector('.description-input');
                    const submitButton = document.querySelector('#image-submit');
                    if (descriptionInput) {
                        descriptionInput.remove();
                    }
                    if (submitButton) {
                        submitButton.remove();
                    }
                    const space = document.createElement("div");
                    space.classList.add("space");
                    descriptionContainer.appendChild(space);
                    selectedImages = [];
                }
            });

            imageWrapper.appendChild(image);
            imageWrapper.appendChild(deleteButton);

            imageContainer.appendChild(imageWrapper);


            let descriptionInput = document.querySelector('.description-input');
            if (!descriptionInput) {
                descriptionInput = document.createElement("textarea");
                descriptionInput.id = "image-description";
                descriptionInput.type = "text";
                descriptionInput.placeholder = "Image description";
                descriptionInput.classList.add("description-input");
                descriptionContainer.appendChild(descriptionInput);
            }

            const space = document.createElement("div");
            space.classList.add("space");
            descriptionContainer.appendChild(space);
            let submitButton = document.querySelector('#image-submit');
            if (!submitButton) {
                submitButton = document.createElement("button");
                submitButton.id = "image-submit";
                submitButton.textContent = "Submit";
                descriptionContainer.appendChild(submitButton);
                submitButton.addEventListener('click', function (e) {
                    e.preventDefault()

                    const description = descriptionInput.value;
                    const files = selectedImages;
                    const data = {
                        num_of_img: files.length,
                        img_path: files,
                        text: description
                    }
                    console.log(data)
                    if (description.trim() === "") {
                        alert("Description cannot be empty.");
                        return;
                    }
                    document.querySelector('#loading-overlay').style.display = 'flex';
                    // 使用 fetch 发起异步请求
                    fetch('/detect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.text();
                            } else {
                                throw new Error('Network response was not ok');
                            }
                        })
                        .then(data => {
                            // 显示上传的图片
                            const res = JSON.parse(data)
                            const classes = res.classes
                            const probs = res.prob
                            const modalImageContainer = document.getElementById('modal-image-container');

                            modalImageContainer.innerHTML = '';  // 清空内容
                            selectedImages.forEach(imageName => {
                                const img = document.createElement('img');
                                img.src = 'images/' + imageName;  // 设置图片路径
                                modalImageContainer.appendChild(img);
                            });
                            const resultContainer = document.getElementById('result-container');
                            resultContainer.style.position = 'fixed';
                            resultContainer.style.zIndex = '999';
                            resultContainer.style.alignItems = 'center';
                            resultContainer.style.justifyContent = 'center';
                            resultContainer.style.textAlign = 'center'
                            resultContainer.style.top = '10%';
                            resultContainer.style.left = '10%';
                            resultContainer.style.width = '80%';
                            resultContainer.style.height = '80%';
                            resultContainer.style.background = 'white';
                            // resultContainer.style.transform = 'translate(-50%, -50%)'
                            // 显示返回的数据
                            const modalDataContainer = document.getElementById('modal-data-container');
                            modalDataContainer.textContent = `Classes: ${classes.join(', ')},Probs: ${probs.join(', ')}`;

                            // 显示模态对话框
                            const modal = document.getElementById('myModal');
                            modal.style.display = 'block';

                            document.querySelector('#loading-overlay').style.display = 'none';
                            selectedImages = []
                            // 获取关闭按钮的元素
                            const closeButton = document.getElementById('modal-close');

                            closeButton.addEventListener('click', function () {
                                // 关闭模态对话框
                                modal.style.display = 'none';
                                location.reload();
                            });

                        })
                        .catch(error => {

                            console.error('Error:', error);
                            selectedImages = []
                            document.querySelector('#loading-overlay').style.display = 'none';
                        });

                });

            }


        }
    }


    function isValidFileType(file) {
        const acceptedTypes = [
            'image/jpg',
            'image/jpeg',
            'image/png',
        ];

        return acceptedTypes.includes(file.type);
    }

    let dropBox = document.querySelector('#drop');

    dropBox.addEventListener('dragover', function (e) {
        e.preventDefault();
    });

    dropBox.addEventListener('drop', function (e) {

        e.preventDefault();
        const droppedFiles = e.dataTransfer.files;
        for (let i = 0; i < droppedFiles.length; i++) {
            if (isValidFileType(droppedFiles[i])) {
                selectedImages.push(droppedFiles[i].name);
            }
        }

        const displayedImagesCount = document.querySelectorAll('.image-wrapper').length;
        let remainingSlots = 2 - displayedImagesCount;
        for (let i = 0; i < droppedFiles.length; i++) {
            if (isValidFileType(droppedFiles[i]) && remainingSlots > 0) {

                displayImage(droppedFiles[i]);
                alert('Success!');
                remainingSlots--;
            } else if (remainingSlots <= 0) {
                alert('You can only upload a maximum of two files. You have ' + displayedImagesCount + ' images already.');
                break;
            } else {
                alert('Please select the correct file type (Image document or Video document)');
            }
        }

    });


</script>
<script>
    // JavaScript代码用于处理注销操作
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('logout-link').addEventListener('click', function () {
            // 发送注销请求到后端（可以使用Ajax或直接跳转到注销路由）
            // 这里示例使用Ajax
            fetch('/dologout', {
                method: 'GET'
            })
                .then(response => {
                    if (response.status === 200) {
                        // 如果后端返回了重定向操作，刷新页面以跳转到登录页面
                        window.location.reload();
                    } else {
                        // 否则，可能显示注销成功消息
                        alert('Logout successful');
                    }
                })
                .catch(error => {
                    alert('Logout failed');
                });
        });
    });
</script>
</body>

</html>